<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebEOR Data Visualizer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.29.3/index.min.js"></script>
    <style>
        /* WebEOR Data Visualizer Styles */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Upload Section */
        .upload-section {
            background: white;
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 60px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background-color: #f8f9ff;
        }

        .upload-icon {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        .upload-content h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #333;
        }

        .upload-content p {
            color: #666;
            margin-bottom: 20px;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        #fileInput {
            display: none;
        }

        /* Progress Bar */
        .upload-status {
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-text {
            text-align: center;
            color: #666;
            font-weight: 500;
        }

        /* Controls Section */
        .controls-section {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* Multi-select for machines */
        .machine-select-container {
            position: relative;
        }

        .machine-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e0e0e0;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .machine-option {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .machine-option:hover {
            background-color: #f8f9ff;
        }

        .machine-option.selected {
            background-color: #667eea;
            color: white;
        }

        .selected-machines {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            min-height: 40px;
            background: white;
            cursor: pointer;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-items: center;
        }

        .machine-tag {
            background: #667eea;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .machine-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .action-btn.secondary {
            background: #6c757d;
        }

        .action-btn.secondary:hover {
            background: #5a6268;
        }

        /* Dashboard */
        .dashboard {
            display: grid;
            gap: 30px;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card h3 {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Charts Grid */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .chart-container h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.2rem;
            text-align: center;
        }

        .chart-container canvas {
            max-height: 300px;
        }

        /* Enhanced chart descriptions */
        .chart-description {
            font-size: 0.9rem;
            color: #666;
            text-align: center;
            margin-bottom: 15px;
            font-style: italic;
        }

        /* Data Table */
        .data-table-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .data-table-container h3 {
            margin-bottom: 20px;
            color: #333;
            font-size: 1.3rem;
        }

        .table-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .table-controls input,
        .table-controls select {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        #dataTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        #dataTable th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        #dataTable td {
            padding: 12px 10px;
            border-bottom: 1px solid #f0f0f0;
        }

        #dataTable tbody tr:hover {
            background-color: #f8f9ff;
        }

        #dataTable tbody tr:nth-child(even) {
            background-color: #fafbff;
        }

        /* Enhanced sorting indicators */
        .sortable {
            cursor: pointer;
            position: relative;
            padding-right: 20px !important;
        }
        
        .sort-asc::after {
            content: '‚Üë';
            position: absolute;
            right: 5px;
        }
        
        .sort-desc::after {
            content: '‚Üì';
            position: absolute;
            right: 5px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .upload-section {
                padding: 20px;
            }
            
            .upload-area {
                padding: 40px 20px;
            }
            
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .table-controls {
                flex-direction: column;
            }
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: #28a745;
        }

        .notification.error {
            background: #dc3545;
        }

        .notification.info {
            background: #17a2b8;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>WebEOR Data Visualizer</h1>
            <p>Upload and analyze postal machine operational data</p>
        </header>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-content">
                    <div class="upload-icon">üìÅ</div>
                    <h3>Select Directory with WebEOR CSV Files</h3>
                    <p>Choose a folder containing multiple WebEOR CSV files to analyze</p>
                    <input type="file" id="fileInput" multiple accept=".csv" webkitdirectory>
                    <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                        Select Directory
                    </button>
                </div>
            </div>
            
            <div class="upload-status" id="uploadStatus" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="status-text" id="statusText">Processing files...</div>
            </div>
        </div>

        <div class="controls-section" id="controlsSection" style="display: none;">
            <div class="filters">
                <div class="filter-group">
                    <label for="dateRange">Date Range:</label>
                    <input type="date" id="startDate">
                    <input type="date" id="endDate">
                    <button onclick="applyDateFilter()">Apply</button>
                </div>
                
                <div class="filter-group">
                    <label>Machines:</label>
                    <div class="machine-select-container">
                        <div class="selected-machines" id="selectedMachines" onclick="toggleMachineDropdown()">
                            <span style="color: #666;">Select machines...</span>
                        </div>
                        <div class="machine-select-dropdown" id="machineDropdown"></div>
                    </div>
                </div>
                
                <div class="filter-group">
                    <label for="tourSelect">Tour:</label>
                    <select id="tourSelect" onchange="applyFilters()">
                        <option value="">All Tours</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="siteSelect">Site:</label>
                    <select id="siteSelect" onchange="applyFilters()">
                        <option value="">All Sites</option>
                    </select>
                </div>
            </div>
            
            <div class="action-buttons">
                <button onclick="exportFilteredData()" class="action-btn">Export Filtered Data</button>
                <button onclick="generateReport()" class="action-btn">Generate Report</button>
                <button onclick="resetFilters()" class="action-btn secondary">Reset Filters</button>
            </div>
        </div>

        <div class="dashboard" id="dashboard" style="display: none;">
            <div class="summary-cards">
                <div class="summary-card">
                    <h3>Total Records</h3>
                    <div class="card-value" id="totalRecords">0</div>
                </div>
                <div class="summary-card">
                    <h3>Unique Machines</h3>
                    <div class="card-value" id="uniqueMachines">0</div>
                </div>
                <div class="summary-card">
                    <h3>Total Fed Count</h3>
                    <div class="card-value" id="totalFed">0</div>
                </div>
                <div class="summary-card">
                    <h3>Date Range</h3>
                    <div class="card-value" id="dateRange">-</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-container">
                    <h3>Machine Utilization by Type</h3>
                    <p class="chart-description">Shows the proportion of total mail processed by each machine type</p>
                    <canvas id="machineTypeChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Daily Activity Pattern</h3>
                    <p class="chart-description">Tracks daily mail processing volume over time</p>
                    <canvas id="dailyActivityChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Machine Activity Over Time</h3>
                    <canvas id="machineActivityChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Tour Activity Heatmap</h3>
                    <canvas id="tourHeatmapChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Machine Performance Trends</h3>
                    <canvas id="performanceTrendChart"></canvas>
                </div>
                
                <div class="chart-container">
                    <h3>Operational Hours Distribution</h3>
                    <canvas id="operationalHoursChart"></canvas>
                </div>
            </div>

            <div class="data-table-container">
                <h3>Raw Data Table</h3>
                <div class="table-controls">
                    <input type="text" id="searchInput" placeholder="Search data..." onkeyup="filterTable()">
                    <select id="sortColumn" onchange="sortTable()">
                        <option value="">Sort by...</option>
                        <option value="Site">Site</option>
                        <option value="MType">Machine Type</option>
                        <option value="MNo">Machine Number</option>
                        <option value="Tour">Tour</option>
                        <option value="Start">Start Time</option>
                        <option value="Fed">Fed Count</option>
                    </select>
                </div>
                <div class="table-wrapper">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                <th class="sortable" onclick="sortTableAdvanced(0)">Site</th>
                                <th class="sortable" onclick="sortTableAdvanced(1)">Machine Type</th>
                                <th class="sortable" onclick="sortTableAdvanced(2)">Machine No</th>
                                <th class="sortable" onclick="sortTableAdvanced(3)">Op No</th>
                                <th class="sortable" onclick="sortTableAdvanced(4)">Tour</th>
                                <th class="sortable" onclick="sortTableAdvanced(5)">Run#</th>
                                <th class="sortable" onclick="sortTableAdvanced(6)">Start</th>
                                <th class="sortable" onclick="sortTableAdvanced(7)">End</th>
                                <th class="sortable" onclick="sortTableAdvanced(8)">Fed Count</th>
                                <th class="sortable" onclick="sortTableAdvanced(9)">Duration</th>
                                <th class="sortable" onclick="sortTableAdvanced(10)">Rate/Hour</th>
                            </tr>
                        </thead>
                        <tbody id="dataTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // WebEOR Data Visualizer JavaScript

        // Global variables
        let rawData = [];
        let filteredData = [];
        let charts = {};
        let selectedMachines = new Set();
        let allMachines = [];
        
        // Enhanced sorting variables
        let currentSortColumn = null;
        let sortDirection = 'asc';

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            setupFileUpload();
            setupEventListeners();
        });

        // File upload setup
        function setupFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('uploadArea');
            
            fileInput.addEventListener('change', handleFileUpload);
            
            // Drag and drop functionality
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#764ba2';
                uploadArea.style.backgroundColor = '#f8f9ff';
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#667eea';
                uploadArea.style.backgroundColor = 'transparent';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#667eea';
                uploadArea.style.backgroundColor = 'transparent';
                
                const files = Array.from(e.dataTransfer.files).filter(file => 
                    file.name.toLowerCase().endsWith('.csv')
                );
                
                if (files.length > 0) {
                    processFiles(files);
                }
            });
        }

        // Handle file upload
        function handleFileUpload(event) {
            const files = Array.from(event.target.files).filter(file => 
                file.name.toLowerCase().endsWith('.csv')
            );
            
            if (files.length === 0) {
                showNotification('Please select CSV files only.', 'error');
                return;
            }
            
            processFiles(files);
        }

        // Process uploaded files
        async function processFiles(files) {
            showProgress();
            const statusText = document.getElementById('statusText');
            const progressFill = document.getElementById('progressFill');
            
            try {
                statusText.textContent = `Processing ${files.length} files...`;
                
                let allData = [];
                const seenRecords = new Set(); // For deduplication
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const progress = ((i + 1) / files.length) * 100;
                    progressFill.style.width = `${progress}%`;
                    statusText.textContent = `Processing: ${file.name} (${i + 1}/${files.length})`;
                    
                    const csvText = await readFileAsText(file);
                    const parsedData = parseCSV(csvText);
                    
                    // Add to combined data with deduplication
                    parsedData.forEach(row => {
                        const recordKey = `${row.Site}-${row.MType}-${row.MNo}-${row.Tour}-${row.Start}-${row.Fed}`;
                        if (!seenRecords.has(recordKey)) {
                            seenRecords.add(recordKey);
                            allData.push(row);
                        }
                    });
                    
                    // Small delay to show progress
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                rawData = allData;
                filteredData = [...rawData];
                
                hideProgress();
                setupDashboard();
                showNotification(`Successfully loaded ${rawData.length} records from ${files.length} files`, 'success');
                
            } catch (error) {
                hideProgress();
                showNotification(`Error processing files: ${error.message}`, 'error');
                console.error('File processing error:', error);
            }
        }

        // Read file as text
        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(new Error('Failed to read file'));
                reader.readAsText(file);
            });
        }

        // Parse CSV data
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
            
            const data = [];
            
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Handle quoted CSV values
                const values = parseCSVLine(line);
                
                if (values.length >= headers.length) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] || '';
                    });
                    
                    // Process and validate the row
                    const processedRow = processRow(row);
                    if (processedRow) {
                        data.push(processedRow);
                    }
                }
            }
            
            return data;
        }

        // Parse a single CSV line (handles quoted values)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        // Process individual row
        function processRow(row) {
            try {
                // Parse dates
                const startDate = parseDate(row.Start);
                const endDate = parseDate(row.End);
                
                if (!startDate || !endDate) return null;
                
                // Calculate duration in hours
                const durationMs = endDate.getTime() - startDate.getTime();
                const durationHours = durationMs / (1000 * 60 * 60);
                
                // Parse Fed count
                const fedCount = parseInt(row.Fed) || 0;
                
                // Calculate rate per hour
                const ratePerHour = durationHours > 0 ? Math.round(fedCount / durationHours) : 0;
                
                return {
                    Site: row.Site,
                    MType: row.MType,
                    MNo: row.MNo,
                    OpNo: row['Op No.'],
                    SortProgram: row['Sort Program'],
                    Tour: parseInt(row.Tour) || 0,
                    RunNo: row['Run#'],
                    Start: startDate,
                    End: endDate,
                    Fed: fedCount,
                    MODS: row.MODS,
                    DOIS: row.DOIS,
                    Duration: Math.round(durationHours * 100) / 100,
                    RatePerHour: ratePerHour,
                    MachineID: `${row.MType} ${row.MNo}`,
                    DateOnly: startDate.toISOString().split('T')[0]
                };
            } catch (error) {
                console.warn('Error processing row:', error, row);
                return null;
            }
        }

        // Parse date string
        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // Handle MM/DD/YY HH:MM format
            const cleanDateStr = dateStr.replace(/"/g, '').trim();
            
            try {
                // Try parsing as-is first
                let date = new Date(cleanDateStr);
                
                // If that fails, try manual parsing for MM/DD/YY format
                if (isNaN(date)) {
                    const parts = cleanDateStr.split(' ');
                    if (parts.length >= 2) {
                        const datePart = parts[0];
                        const timePart = parts[1];
                        
                        const [month, day, year] = datePart.split('/');
                        const fullYear = year.length === 2 ? `20${year}` : year;
                        
                        date = new Date(`${fullYear}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${timePart}`);
                    }
                }
                
                return isNaN(date) ? null : date;
            } catch (error) {
                console.warn('Date parsing error:', error, dateStr);
                return null;
            }
        }

        // Setup dashboard
        function setupDashboard() {
            document.getElementById('controlsSection').style.display = 'block';
            document.getElementById('dashboard').style.display = 'block';
            
            populateFilters();
            updateSummaryCards();
            createCharts();
            populateDataTable();
        }

        // Populate filter dropdowns
        function populateFilters() {
            allMachines = [...new Set(rawData.map(row => row.MachineID))].sort();
            const tours = [...new Set(rawData.map(row => row.Tour))].sort((a, b) => a - b);
            const sites = [...new Set(rawData.map(row => row.Site))].sort();
            
            populateMachineDropdown();
            populateSelect('tourSelect', tours);
            populateSelect('siteSelect', sites);
            
            // Set date range
            const dates = rawData.map(row => row.Start).sort();
            if (dates.length > 0) {
                document.getElementById('startDate').value = formatDateForInput(dates[0]);
                document.getElementById('endDate').value = formatDateForInput(dates[dates.length - 1]);
            }
        }

        // Populate machine dropdown
        function populateMachineDropdown() {
            const dropdown = document.getElementById('machineDropdown');
            dropdown.innerHTML = '';
            
            // Add "All Machines" option
            const allOption = document.createElement('div');
            allOption.className = 'machine-option';
            allOption.textContent = 'All Machines';
            allOption.onclick = () => selectAllMachines();
            dropdown.appendChild(allOption);
            
            // Add individual machine options
            allMachines.forEach(machine => {
                const option = document.createElement('div');
                option.className = 'machine-option';
                option.textContent = machine;
                option.onclick = () => toggleMachine(machine);
                dropdown.appendChild(option);
            });
        }

        // Toggle machine dropdown
        function toggleMachineDropdown() {
            const dropdown = document.getElementById('machineDropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        // Toggle machine selection
        function toggleMachine(machine) {
            if (selectedMachines.has(machine)) {
                selectedMachines.delete(machine);
            } else {
                selectedMachines.add(machine);
            }
            updateSelectedMachinesDisplay();
            applyFilters();
        }

        // Select all machines
        function selectAllMachines() {
            selectedMachines.clear();
            allMachines.forEach(machine => selectedMachines.add(machine));
            updateSelectedMachinesDisplay();
            applyFilters();
        }

        // Update selected machines display
        function updateSelectedMachinesDisplay() {
            const container = document.getElementById('selectedMachines');
            container.innerHTML = '';
            
            if (selectedMachines.size === 0) {
                const span = document.createElement('span');
                span.style.color = '#666';
                span.textContent = 'Select machines...';
                container.appendChild(span);
            } else if (selectedMachines.size === allMachines.length) {
                const span = document.createElement('span');
                span.style.color = '#666';
                span.textContent = 'All Machines Selected';
                container.appendChild(span);
            } else {
                selectedMachines.forEach(machine => {
                    const tag = document.createElement('div');
                    tag.className = 'machine-tag';
                    tag.innerHTML = `${machine} <span class="remove" onclick="event.stopPropagation(); toggleMachine('${machine}')">√ó</span>`;
                    container.appendChild(tag);
                });
            }

            // Update dropdown selections
            const dropdown = document.getElementById('machineDropdown');
            const options = dropdown.querySelectorAll('.machine-option');
            options.forEach(option => {
                const machine = option.textContent;
                option.classList.toggle('selected', selectedMachines.has(machine));
            });
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const container = document.querySelector('.machine-select-container');
            const dropdown = document.getElementById('machineDropdown');
            
            if (!container.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });

        // Populate select element
        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            const currentValue = select.value;
            
            // Keep the "All" option and add new options
            const existingOptions = select.querySelectorAll('option');
            for (let i = 1; i < existingOptions.length; i++) {
                existingOptions[i].remove();
            }
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
            
            select.value = currentValue;
        }

        // Format date for input
        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        // Update summary cards
        function updateSummaryCards() {
            const totalRecords = filteredData.length;
            const uniqueMachines = new Set(filteredData.map(row => row.MachineID)).size;
            const totalFed = filteredData.reduce((sum, row) => sum + row.Fed, 0);
            
            const dates = filteredData.map(row => row.Start).sort();
            const dateRange = dates.length > 0 ? 
                `${formatDate(dates[0])} - ${formatDate(dates[dates.length - 1])}` : '-';
            
            document.getElementById('totalRecords').textContent = totalRecords.toLocaleString();
            document.getElementById('uniqueMachines').textContent = uniqueMachines.toLocaleString();
            document.getElementById('totalFed').textContent = totalFed.toLocaleString();
            document.getElementById('dateRange').textContent = dateRange;
        }

        // Format date for display
        function formatDate(date) {
            return date.toLocaleDateString();
        }

        // Create charts
        function createCharts() {
            createMachineTypeChart();
            createDailyActivityChart();
            createMachineActivityChart();
            createTourHeatmapChart();
            createPerformanceTrendChart();
            createOperationalHoursChart();
        }

        // Enhanced Machine Type Chart - showing Fed proportion
        function createMachineTypeChart() {
            const ctx = document.getElementById('machineTypeChart').getContext('2d');
            
            const machineTypeFed = {};
            filteredData.forEach(row => {
                machineTypeFed[row.MType] = (machineTypeFed[row.MType] || 0) + row.Fed;
            });
            
            const labels = Object.keys(machineTypeFed);
            const data = Object.values(machineTypeFed);
            
            if (charts.machineType) charts.machineType.destroy();
            
            charts.machineType = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c',
                            '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Daily Activity Chart
        function createDailyActivityChart() {
            const ctx = document.getElementById('dailyActivityChart').getContext('2d');
            
            const dailyActivity = {};
            filteredData.forEach(row => {
                const date = row.DateOnly;
                dailyActivity[date] = (dailyActivity[date] || 0) + row.Fed;
            });
            
            const sortedDates = Object.keys(dailyActivity).sort();
            const labels = sortedDates.map(date => new Date(date).toLocaleDateString());
            const data = sortedDates.map(date => dailyActivity[date]);
            
            if (charts.dailyActivity) charts.dailyActivity.destroy();
            
            charts.dailyActivity = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Fed Count',
                        data: data,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Fed Count'
                            }
                        }
                    }
                }
            });
        }

        // Machine Activity Over Time Chart (Step Chart)
        function createMachineActivityChart() {
            const ctx = document.getElementById('machineActivityChart').getContext('2d');
            
            // Get machines to display (selected or all if none selected)
            const machinesToShow = selectedMachines.size > 0 ? 
                Array.from(selectedMachines) : 
                allMachines.slice(0, 10); // Limit to 10 for readability
            
            const colors = [
                '#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe',
                '#00f2fe', '#43e97b', '#38f9d7', '#ff9a9e', '#fecfef'
            ];
            
            // Get all unique time points and sort them
            const allTimes = [];
            filteredData.forEach(row => {
                if (machinesToShow.length === 0 || machinesToShow.includes(row.MachineID)) {
                    allTimes.push(row.Start.getTime(), row.End.getTime());
                }
            });
            const uniqueTimes = [...new Set(allTimes)].sort((a, b) => a - b);
            
            // Create labels from timestamps
            const labels = uniqueTimes.map(time => {
                const date = new Date(time);
                return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            });
            
            const datasets = [];
            
            machinesToShow.forEach((machine, index) => {
                const machineData = filteredData
                    .filter(row => row.MachineID === machine)
                    .sort((a, b) => a.Start.getTime() - b.Start.getTime());
                
                if (machineData.length === 0) return;
                
                // Create step data for this machine
                const stepData = uniqueTimes.map(time => {
                    // Find if this machine is running at this time
                    const runningJob = machineData.find(row => 
                        time >= row.Start.getTime() && time <= row.End.getTime()
                    );
                    return runningJob ? runningJob.Fed : 0;
                });
                
                datasets.push({
                    label: machine,
                    data: stepData,
                    borderColor: colors[index % colors.length],
                    backgroundColor: colors[index % colors.length] + '20',
                    stepped: 'before',
                    fill: false,
                    pointRadius: 0,
                    borderWidth: 2
                });
            });
            
            if (charts.machineActivity) charts.machineActivity.destroy();
            
            charts.machineActivity = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            },
                            ticks: {
                                maxTicksLimit: 10,
                                callback: function(value, index) {
                                    // Show every nth label to avoid crowding
                                    const step = Math.ceil(labels.length / 8);
                                    return index % step === 0 ? labels[index] : '';
                                }
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Fed Count'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                title: function(context) {
                                    return labels[context[0].dataIndex];
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }

        // Enhanced Tour Heatmap Chart with throughput line
        function createTourHeatmapChart() {
            const ctx = document.getElementById('tourHeatmapChart').getContext('2d');
            
            const tourHours = {};
            const avgThroughput = new Array(24).fill(0);
            const hourCounts = new Array(24).fill(0);
            
            filteredData.forEach(row => {
                const hour = row.Start.getHours();
                const tour = row.Tour;
                const key = `Tour ${tour}`;
                
                if (!tourHours[key]) tourHours[key] = new Array(24).fill(0);
                tourHours[key][hour]++;
                
                // Calculate average throughput
                avgThroughput[hour] += row.RatePerHour;
                hourCounts[hour]++;
            });
            
            const datasets = Object.keys(tourHours).map((tour, index) => {
                const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c'];
                return {
                    label: tour,
                    data: tourHours[tour],
                    backgroundColor: colors[index % colors.length] + '80',
                    borderColor: colors[index % colors.length],
                    borderWidth: 1
                };
            });
            
            // Add average throughput dataset
            const avgDataset = {
                label: 'Avg Throughput',
                data: avgThroughput.map((val, i) => hourCounts[i] > 0 ? Math.round(val/hourCounts[i]) : 0),
                type: 'line',
                borderColor: '#ff0000',
                backgroundColor: 'rgba(255,0,0,0.1)',
                yAxisID: 'y2',
                tension: 0.3
            };
            
            datasets.push(avgDataset);
            
            if (charts.tourHeatmap) charts.tourHeatmap.destroy();
            
            charts.tourHeatmap = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${i}:00`),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Hour of Day'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Runs'
                            }
                        },
                        y2: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Avg Throughput (Fed/Hour)'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            });
        }

        // Performance Trend Chart
        function createPerformanceTrendChart() {
            const ctx = document.getElementById('performanceTrendChart').getContext('2d');
            
            const machinePerformance = {};
            filteredData.forEach(row => {
                const machine = row.MachineID;
                if (!machinePerformance[machine]) {
                    machinePerformance[machine] = [];
                }
                machinePerformance[machine].push({
                    date: row.DateOnly,
                    rate: row.RatePerHour
                });
            });
            
            // Get top 5 machines by total runs
            const topMachines = Object.keys(machinePerformance)
                .sort((a, b) => machinePerformance[b].length - machinePerformance[a].length)
                .slice(0, 5);
            
            const datasets = topMachines.map((machine, index) => {
                const colors = ['#667eea', '#764ba2', '#f093fb', '#f5576c', '#4facfe'];
                const dailyAvg = {};
                
                machinePerformance[machine].forEach(entry => {
                    if (!dailyAvg[entry.date]) dailyAvg[entry.date] = [];
                    dailyAvg[entry.date].push(entry.rate);
                });
                
                const sortedDates = Object.keys(dailyAvg).sort();
                const avgRates = sortedDates.map(date => {
                    const rates = dailyAvg[date];
                    return rates.reduce((sum, rate) => sum + rate, 0) / rates.length;
                });
                
                return {
                    label: machine,
                    data: avgRates,
                    borderColor: colors[index],
                    backgroundColor: colors[index] + '20',
                    fill: false,
                    tension: 0.4
                };
            });
            
            if (charts.performanceTrend) charts.performanceTrend.destroy();
            
            charts.performanceTrend = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: Object.keys(machinePerformance[topMachines[0]] ? 
                        machinePerformance[topMachines[0]].reduce((acc, entry) => {
                            acc[entry.date] = true;
                            return acc;
                        }, {}) : {}).sort().map(date => new Date(date).toLocaleDateString()),
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Average Rate (Fed/Hour)'
                            }
                        }
                    }
                }
            });
        }

        // Enhanced Operational Hours Chart - showing tour distribution
        function createOperationalHoursChart() {
            const ctx = document.getElementById('operationalHoursChart').getContext('2d');
            
            const tourFed = {};
            filteredData.forEach(row => {
                tourFed[row.Tour] = (tourFed[row.Tour] || 0) + row.Fed;
            });
            
            const labels = Object.keys(tourFed).map(tour => `Tour ${tour}`);
            const data = Object.values(tourFed);
            
            if (charts.operationalHours) charts.operationalHours.destroy();
            
            charts.operationalHours = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#667eea', '#764ba2', '#f093fb', '#f5576c',
                            '#4facfe', '#00f2fe'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        // Populate data table
        function populateDataTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            // Limit to first 1000 rows for performance
            const displayData = filteredData.slice(0, 1000);
            
            displayData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.Site}</td>
                    <td>${row.MType}</td>
                    <td>${row.MNo}</td>
                    <td>${row.OpNo}</td>
                    <td>${row.Tour}</td>
                    <td>${row.RunNo}</td>
                    <td>${formatDateTime(row.Start)}</td>
                    <td>${formatDateTime(row.End)}</td>
                    <td>${row.Fed.toLocaleString()}</td>
                    <td>${row.Duration}h</td>
                    <td>${row.RatePerHour.toLocaleString()}</td>
                `;
                tbody.appendChild(tr);
            });
            
            if (filteredData.length > 1000) {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td colspan="11" style="text-align: center; font-style: italic;">
                    Showing first 1000 of ${filteredData.length.toLocaleString()} records
                </td>`;
                tbody.appendChild(tr);
            }
        }

        // Format date and time
        function formatDateTime(date) {
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        // Enhanced table sorting
        function sortTableAdvanced(columnIndex) {
            // Reset previous sort indicator
            document.querySelectorAll('.sort-asc, .sort-desc').forEach(el => {
                el.classList.remove('sort-asc', 'sort-desc');
            });
            
            // Set new sort indicator
            const header = document.querySelector(`#dataTable th:nth-child(${columnIndex + 1})`);
            
            // Toggle direction if same column
            if (currentSortColumn === columnIndex) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = columnIndex;
                sortDirection = 'asc';
            }
            
            header.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
            
            // Perform sort
            filteredData.sort((a, b) => {
                // Get values to compare
                let valA, valB;
                
                switch(columnIndex) {
                    case 0: valA = a.Site; valB = b.Site; break;
                    case 1: valA = a.MType; valB = b.MType; break;
                    case 2: valA = a.MNo; valB = b.MNo; break;
                    case 3: valA = a.OpNo; valB = b.OpNo; break;
                    case 4: valA = a.Tour; valB = b.Tour; break;
                    case 5: valA = a.RunNo; valB = b.RunNo; break;
                    case 6: valA = a.Start; valB = b.Start; break;
                    case 7: valA = a.End; valB = b.End; break;
                    case 8: valA = a.Fed; valB = b.Fed; break;
                    case 9: valA = a.Duration; valB = b.Duration; break;
                    case 10: valA = a.RatePerHour; valB = b.RatePerHour; break;
                    default: return 0;
                }
                
                // Handle different data types
                if (valA instanceof Date) {
                    return sortDirection === 'asc' ? 
                        valA.getTime() - valB.getTime() : 
                        valB.getTime() - valA.getTime();
                }
                
                if (typeof valA === 'number') {
                    return sortDirection === 'asc' ? valA - valB : valB - valA;
                }
                
                // String comparison
                return sortDirection === 'asc' ? 
                    valA.localeCompare(valB) : 
                    valB.localeCompare(valA);
            });
            
            populateDataTable();
        }

        // Apply filters
        function applyFilters() {
            const tourFilter = document.getElementById('tourSelect').value;
            const siteFilter = document.getElementById('siteSelect').value;
            
            filteredData = rawData.filter(row => {
                const machineMatch = selectedMachines.size === 0 || selectedMachines.has(row.MachineID);
                const tourMatch = !tourFilter || row.Tour.toString() === tourFilter;
                const siteMatch = !siteFilter || row.Site === siteFilter;
                
                return machineMatch && tourMatch && siteMatch;
            });
            
            updateDashboard();
        }

        // Apply date filter
        function applyDateFilter() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            endDate.setHours(23, 59, 59, 999); // Include full end date
            
            if (isNaN(startDate) || isNaN(endDate)) {
                showNotification('Please select valid dates', 'error');
                return;
            }
            
            filteredData = filteredData.filter(row => {
                return row.Start >= startDate && row.Start <= endDate;
            });
            
            updateDashboard();
        }

        // Reset filters
        function resetFilters() {
            selectedMachines.clear();
            updateSelectedMachinesDisplay();
            document.getElementById('tourSelect').value = '';
            document.getElementById('siteSelect').value = '';
            
            const dates = rawData.map(row => row.Start).sort();
            if (dates.length > 0) {
                document.getElementById('startDate').value = formatDateForInput(dates[0]);
                document.getElementById('endDate').value = formatDateForInput(dates[dates.length - 1]);
            }
            
            filteredData = [...rawData];
            updateDashboard();
        }

        // Update dashboard
        function updateDashboard() {
            updateSummaryCards();
            createCharts();
            populateDataTable();
        }

        // Filter table
        function filterTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#dataTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }

        // Sort table
        function sortTable() {
            const column = document.getElementById('sortColumn').value;
            if (!column) return;
            
            const columnMap = {
                'Site': 0, 'MType': 1, 'MNo': 2, 'Tour': 4, 'Start': 6, 'Fed': 8
            };
            
            const columnIndex = columnMap[column];
            if (columnIndex === undefined) return;
            
            // Sort filtered data
            filteredData.sort((a, b) => {
                let valueA, valueB;
                
                switch (column) {
                    case 'Tour':
                        valueA = a.Tour;
                        valueB = b.Tour;
                        break;
                    case 'Start':
                        valueA = a.Start;
                        valueB = b.Start;
                        break;
                    case 'Fed':
                        valueA = a.Fed;
                        valueB = b.Fed;
                        break;
                    default:
                        valueA = a[column] || '';
                        valueB = b[column] || '';
                }
                
                if (typeof valueA === 'string') {
                    return valueA.localeCompare(valueB);
                }
                return valueA - valueB;
            });
            
            populateDataTable();
        }

        // Export filtered data
        function exportFilteredData() {
            if (filteredData.length === 0) {
                showNotification('No data to export', 'error');
                return;
            }
            
            const headers = ['Site', 'MType', 'MNo', 'Op No.', 'Sort Program', 'Tour', 'Run#', 
                            'Start', 'End', 'Fed', 'MODS', 'DOIS', 'Duration', 'Rate/Hour'];
            
            let csvContent = headers.join(',') + '\n';
            
            filteredData.forEach(row => {
                const csvRow = [
                    `"${row.Site}"`,
                    `"${row.MType}"`,
                    `"${row.MNo}"`,
                    `"${row.OpNo}"`,
                    `"${row.SortProgram}"`,
                    row.Tour,
                    `"${row.RunNo}"`,
                    `"${formatDateTime(row.Start)}"`,
                    `"${formatDateTime(row.End)}"`,
                    row.Fed,
                    `"${row.MODS}"`,
                    `"${row.DOIS}"`,
                    row.Duration,
                    row.RatePerHour
                ];
                csvContent += csvRow.join(',') + '\n';
            });
            
            downloadCSV(csvContent, 'webeor_filtered_data.csv');
            showNotification('Data exported successfully', 'success');
        }

        // Generate report
        function generateReport() {
            const report = generateAnalysisReport();
            downloadReport(report, 'webeor_analysis_report.html');
            showNotification('Report generated successfully', 'success');
        }

        // Enhanced report generation with new machine analysis
        function generateAnalysisReport() {
            // Calculate min and max dates
            let minDate = null;
            let maxDate = null;
            
            filteredData.forEach(row => {
                if (!minDate || row.Start < minDate) minDate = row.Start;
                if (!maxDate || row.End > maxDate) maxDate = row.End;
            });
            
            const dateRange = minDate && maxDate ? 
                `${formatDateTime(minDate)} to ${formatDateTime(maxDate)}` : 
                'No data';
                
            const machineStats = {};
            
            filteredData.forEach(row => {
                const machine = row.MachineID;
                if (!machineStats[machine]) {
                    machineStats[machine] = {
                        runs: 0,
                        totalFed: 0,
                        days: new Set(),
                        weeks: new Set(),
                        toursPerDay: {}
                    };
                }
                
                const stat = machineStats[machine];
                stat.runs++;
                stat.totalFed += row.Fed;
                
                // Track days and weeks
                const dateStr = row.DateOnly;
                stat.days.add(dateStr);
                
                const week = getWeekNumber(row.Start);
                stat.weeks.add(week);
                
                // Track tours per day
                if (!stat.toursPerDay[dateStr]) {
                    stat.toursPerDay[dateStr] = new Set();
                }
                stat.toursPerDay[dateStr].add(row.Tour);
            });
            
            // Convert to array for report
            const allMachineStats = Object.keys(machineStats).map(machine => {
                const stat = machineStats[machine];
                const days = stat.days.size;
                const weeks = stat.weeks.size;
                
                // Calculate tours per day (average)
                let totalTours = 0;
                Object.values(stat.toursPerDay).forEach(set => {
                    totalTours += set.size;
                });
                const avgToursPerDay = days > 0 ? (totalTours / days).toFixed(1) : 0;
                
                // Calculate days per week (average)
                const avgDaysPerWeek = weeks > 0 ? (days / weeks).toFixed(1) : 0;
                
                return {
                    machine,
                    runs: stat.runs,
                    totalFed: stat.totalFed,
                    avgFed: Math.round(stat.totalFed / stat.runs),
                    avgToursPerDay,
                    avgDaysPerWeek
                };
            }).sort((a, b) => b.totalFed - a.totalFed);
            
            // Generate report HTML with new columns
            return `
            <!DOCTYPE html>
            <html>
            <head>
                <title>WebEOR Analysis Report</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 40px; }
                    .header { text-align: center; margin-bottom: 30px; }
                    .summary { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
                    .section { margin-bottom: 30px; }
                    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #667eea; color: white; }
                    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
                    .stat-card { background: #f9f9f9; padding: 15px; border-radius: 8px; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h1>WebEOR Data Analysis Report</h1>
                    <p>Data range: ${dateRange}</p>
                    <p>Total records: ${filteredData.length.toLocaleString()}</p>
                    <p>Generated on ${new Date().toLocaleDateString()}</p>
                </div>
                
                <table>
                    <tr>
                        <th>Machine</th>
                        <th>Total Runs</th>
                        <th>Total Fed Count</th>
                        <th>Avg Fed/Run</th>
                        <th>Avg. Tours/Day</th>
                        <th>Avg. Days/Week</th>
                    </tr>
                    ${allMachineStats.map(m => `
                        <tr>
                            <td>${m.machine}</td>
                            <td>${m.runs.toLocaleString()}</td>
                            <td>${m.totalFed.toLocaleString()}</td>
                            <td>${m.avgFed.toLocaleString()}</td>
                            <td>${m.avgToursPerDay}</td>
                            <td>${m.avgDaysPerWeek}</td>
                        </tr>
                    `).join('')}
                </table>
            </body>
            </html>
            `;
        }
        
        // Helper to get ISO week number
        function getWeekNumber(date) {
            const d = new Date(date);
            d.setHours(0,0,0,0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(),0,1);
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1)/7);
            return `${d.getFullYear()}-W${weekNo.toString().padStart(2, '0')}`;
        }

        // Get all machine statistics
        function getAllMachineStats() {
            const machineStats = {};
            
            filteredData.forEach(row => {
                const machine = row.MachineID;
                if (!machineStats[machine]) {
                    machineStats[machine] = { 
                        runs: 0, 
                        totalFed: 0, 
                        totalHours: 0,
                        rates: []
                    };
                }
                machineStats[machine].runs++;
                machineStats[machine].totalFed += row.Fed;
                machineStats[machine].totalHours += row.Duration;
                machineStats[machine].rates.push(row.RatePerHour);
            });
            
            return Object.keys(machineStats)
                .map(machine => {
                    const stats = machineStats[machine];
                    const avgFed = Math.round(stats.totalFed / stats.runs);
                    const avgRate = Math.round(stats.rates.reduce((a, b) => a + b, 0) / stats.rates.length);
                    
                    // Calculate efficiency score based on utilization and performance
                    const maxFed = Math.max(...Object.values(machineStats).map(s => s.totalFed));
                    const maxRuns = Math.max(...Object.values(machineStats).map(s => s.runs));
                    const fedScore = (stats.totalFed / maxFed) * 50;
                    const utilizationScore = (stats.runs / maxRuns) * 50;
                    const efficiencyScore = fedScore + utilizationScore;
                    
                    return {
                        machine,
                        runs: stats.runs,
                        totalFed: stats.totalFed,
                        avgFed,
                        totalHours: stats.totalHours,
                        avgRate,
                        efficiencyScore
                    };
                })
                .sort((a, b) => b.totalFed - a.totalFed);
        }

        // Get tour statistics
        function getTourStats() {
            const tourStats = {};
            const tourHours = {};
            
            filteredData.forEach(row => {
                const tour = row.Tour;
                const hour = row.Start.getHours();
                
                if (!tourStats[tour]) {
                    tourStats[tour] = { runs: 0, totalFed: 0 };
                }
                if (!tourHours[tour]) {
                    tourHours[tour] = {};
                }
                
                tourStats[tour].runs++;
                tourStats[tour].totalFed += row.Fed;
                tourHours[tour][hour] = (tourHours[tour][hour] || 0) + 1;
            });
            
            return Object.keys(tourStats)
                .map(tour => {
                    const stats = tourStats[tour];
                    const avgFed = Math.round(stats.totalFed / stats.runs);
                    
                    // Find peak hours for this tour
                    const hours = tourHours[tour];
                    const peakHours = Object.keys(hours)
                        .sort((a, b) => hours[b] - hours[a])
                        .slice(0, 3)
                        .map(h => `${h}:00`);
                    
                    return {
                        tour: parseInt(tour),
                        runs: stats.runs,
                        totalFed: stats.totalFed,
                        avgFed,
                        peakHours
                    };
                })
                .sort((a, b) => a.tour - b.tour);
        }

        // Get peak hours
        function getPeakHours() {
            const hourStats = {};
            
            filteredData.forEach(row => {
                const hour = row.Start.getHours();
                if (!hourStats[hour]) {
                    hourStats[hour] = { runs: 0, totalFed: 0 };
                }
                hourStats[hour].runs++;
                hourStats[hour].totalFed += row.Fed;
            });
            
            return Object.keys(hourStats)
                .map(hour => ({
                    hour: parseInt(hour),
                    runs: hourStats[hour].runs,
                    totalFed: hourStats[hour].totalFed,
                    avgFed: Math.round(hourStats[hour].totalFed / hourStats[hour].runs)
                }))
                .sort((a, b) => b.runs - a.runs)
                .slice(0, 10);
        }

        // Download CSV
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Download report
        function downloadReport(content, filename) {
            const blob = new Blob([content], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Utility functions
        function showProgress() {
            document.getElementById('uploadStatus').style.display = 'block';
        }

        function hideProgress() {
            document.getElementById('uploadStatus').style.display = 'none';
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 5000);
        }

        function setupEventListeners() {
            // Any additional event listeners can be added here
        }
    </script>
</body>
</html>